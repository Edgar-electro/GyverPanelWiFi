# Настройка параметров в приложении

## Подключение к устройству

Итак, прошивка настроена, скомпилирована и загружена в микроконтроллер. Микроконтроллер запустился и в окне монитора порта вы видите сообщение, 
что точка доступа **PanelAP** создана со стандартным IP **192.168.4.1** и стандартным паролем 12341234.  

![Монитор порта](https://github.com/vvip-68/GyverPanelWiFi/blob/master/wiki/Tune/p01.png)
               
Откройте в телефоне настройки WiFi подключений, найдите созданную сеть **PanelAP**  

![PanelAP-1](https://github.com/vvip-68/GyverPanelWiFi/blob/master/wiki/Tune/p03.png)

Выберите сеть **PanelAP**, введите в поле пароля пароль **12341234** и нажмите кнопку **"Подключиться"**  

![PanelAP-2](https://github.com/vvip-68/GyverPanelWiFi/blob/master/wiki/Tune/p02.png)

Ваш телефон подключился к точ	ке доступа, созданной устройством  

![PanelAP-3](https://github.com/vvip-68/GyverPanelWiFi/blob/master/wiki/Tune/p04.png)

Найдите в папке проекта **Android/AppInventor** файл приложения ***GyverPanelWiFi.apk***
и установите его на ваш смартфон. Запустите приложение.

![Приложение-1](https://github.com/vvip-68/GyverPanelWiFi/blob/master/wiki/Tune/p05.png)

В списке доступных подключений уже выбрано подключение **PanelAP**, параметры подключения - **192.168.4.1:2390**. Нажмите кнопку **"Подключить"**.  

Приложение подключится к устройству. В верхней части экрана приложения вы увидите набор кнопок, позволяющих переключаться между страницами интерфейса приложения.
Перейдите на страницу **"Настройки подключения"**.

![Приложение-2](https://github.com/vvip-68/GyverPanelWiFi/blob/master/wiki/Tune/p06.png)

В секции **"Параметры сети"** укажите имя сети (SSID) и пароль доступа в сеть. В поле **"Текущий IP"** укажите желаемый адрес, 
который получит устройство в вашей сети. Обратите внимание, что IP адрес должен быть свободным, то есть не принадлежать какому-либо другому работающему в сети устройству.
При необходимости проверьте адреса вашей сети в настройках вашего роутера. Нажмите кнопку **"Сохранить"**. 
Для верности - можно нажать несколько раз - не всегда пакеты с данными успешно доходят до устройства.

Устройство выполнит переподключение к сети с указанным адресом. Вы увидите соответствующие сообщения в мониторе порта.
На матрице устройства бегущей строкой отобразится адрес, полученный устройством.

После того, как настройки сети применены и устройство перезагрузилось - приложение потеряет связь с устройством.  
Перейдите в приложении на страничку начального подключения и нажмите кнопку **"Добавить"**.

![Приложение-3](https://github.com/vvip-68/GyverPanelWiFi/blob/master/wiki/Tune/p05.png)

После нажатия на кнопку **"Добавить"** откроется страница создания нового подключения.

![Приложение-4](https://github.com/vvip-68/GyverPanelWiFi/blob/master/wiki/Tune/p08.png)

В поле **"Имя"** дайте имя создаваемому соединению. Это имя позже можно будет выбрать из списка созданных соединений для быстрого выбора устройства для подключения.  
В поле **"IP адрес"** укажите IP адрес, который получило ваше устройство при регистрации в вашей локальной сети.  
В поле **"Порт"** укажите порт подключения, который был указан на этапе конфигурирования прошивки перед компиляцией. Значение по умолчанию ***2390***  
Обратите внимание, что при настройке соединения отмечен чекбокс **"Локальная сеть"**

Нажмите кнопку **"Подключить"**. Приложение сохранит введенные настройки подключения для дальнейшего использования.  
После подключения к устройству вы снова увидите в приложении доступные элементы управления.

## Управление по каналу MQTT

Если в настройках прошивки вы указали возможность использования управления по [каналу MQTT](https://github.com/vvip-68/GyverPanelWiFi/wiki/%D0%9D%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0-%D0%BF%D0%BE%D0%B4%D0%BA%D0%BB%D1%8E%D1%87%D0%B5%D0%BD%D0%B8%D1%8F-%D0%BA-MQTT-%D1%81%D0%B5%D1%80%D0%B2%D0%B5%D1%80%D1%83)  
```#define USE_MQTT 1```  
выполните в приложении на смартфоне [настройку](https://github.com/vvip-68/GyverPanelWiFi/wiki/%D0%9D%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0-%D0%BF%D0%BE%D0%B4%D0%BA%D0%BB%D1%8E%D1%87%D0%B5%D0%BD%D0%B8%D1%8F-%D0%BA-MQTT-%D1%81%D0%B5%D1%80%D0%B2%D0%B5%D1%80%D1%83#%D0%9D%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0-%D0%BF%D0%B0%D1%80%D0%B0%D0%BC%D0%B5%D1%82%D1%80%D0%BE%D0%B2-mqtt-%D0%B2-%D0%BF%D1%80%D0%B8%D0%BB%D0%BE%D0%B6%D0%B5%D0%BD%D0%B8%D0%B8) 
связи с использованием этого канала.

```
Управление по каналу MQTT позволяет управлять устройством не находясь в непосредственной близости от него.
Если ваша гирлянда висит на балконе 12-го этажа многоэтажного здания и с улицы видна только через дорогу от него - вам скорее всего не удастся подключится 
к вашей локальной сети. В этом случае может быть использовано управление по каналу MQTT - гирлянда будет доступна даже если вы находитесь в другом городе.
```

### Настройка подключения со стороны устройства

Подключитесь к вашему устройству, используя уже настроенный вами канал ***"Локальная сеть"***.  
Перейдите на страничку настройки соединения к секции **"Настройки MQTT"**.  

![Приложение-5](https://github.com/vvip-68/GyverPanelWiFi/blob/master/wiki/Tune/p07.png)

Вы можете использовать любой публичный MQTT-брокер, который соответствует [требованиям](https://github.com/vvip-68/GyverPanelWiFi/wiki/%D0%9D%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0-%D0%BF%D0%BE%D0%B4%D0%BA%D0%BB%D1%8E%D1%87%D0%B5%D0%BD%D0%B8%D1%8F-%D0%BA-MQTT-%D1%81%D0%B5%D1%80%D0%B2%D0%B5%D1%80%D1%83#%D0%A2%D1%80%D0%B5%D0%B1%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5-%D0%BA-mqtt-%D1%81%D0%B5%D1%80%D0%B2%D0%B5%D1%80%D1%83) 
или установить и настроить свой собственный MQTT-сервер. По умолчанию устройство использует бесплатный MQTT-брокер ***mqtt.iotwithus.com*** на порту **1883**. 
Укажите имя сервера MQTT и порт подключения в полях **"Имя сервера"** и **"Порт"** соответственно.  

Выбранный нами сервер ***mqtt.iotwithus.com*** не использует авторизацию по ***Логину*** и ***Паролю*** - оставьте эти поля пустыми.
Если ваш брокер использует авторизацию - укажите в этих полях **Логин** и **Пароль** для доступа к вашему аккаунту на сервере.  

Уникальность соединения канала управления без использования авторизации (логин и пароль) обеспечивается выбранным префиксом, добавляемым к
топику команд управления устройством. Придумайте уникальное значение и укажите его в поле **"Префикс"**. В нашем случае используется префикс ***smtk4d32***.
Используйте только латинские буквы, цифры, знак подчеркивания и минус.  

Если канал связи с авторизацией - можете указать в поле **"Префикс"** люое понятное вам значение, например ***WiFiPanel***.  

В поле **"Интервал отправки значения uptime"** укажите периодичность отправки устройством уведомлений о его состоянии (включено/выключено) и время его бесперебойной работы. 
Рекомендуется оставить настройки по-умолчанию - ***60 секунд***.  

Нажмите кнопку **"Сохранить"** для отправки настроек в устройство.  
Отметьте чекбокс **"Использовать MQTT"** для активации соединения.  

В мониторе порта вы увидите, что устройство отправило брокеру пакет со значениями своего текущего состояния.  
Устройство готово к работе по каналу MQTT.  

### Настройка подключения со стороны приложения

Откройте в приложении страницу настроек соединения, выберите в комбобоксе созданное соединение с вашим устройством и нажмите кнопку **"Править"**.  

![Приложение-6](https://github.com/vvip-68/GyverPanelWiFi/blob/master/wiki/Tune/p09.png)

Настройте параметры соединения с устройством через канал MQTT:  

![Приложение-7](https://github.com/vvip-68/GyverPanelWiFi/blob/master/wiki/Tune/p10.png)

Установите чекбокс способа подключения - **MQTT канал**  
В полях **"Сервер"** и **"Порт"** укажите имя MQTT-сервера и порт, как вы указали их в настройках подключения со стороны устройства выше.  
Укажите **"Логин"** и **"Пароль"** для подключения к серверу или оставьте их пустыми, если сервер не требует авторизации.  
В поле **"Префикс"** укажите тот же префикс, который вы использовали в ***Настройках подключения*** со стороны устройства выше.  

Нажмите кнопку **"Сохранить"** вверху страницы или сразу кнопку **"Подключить"** - настройки соединения будут сохранены.  

Какой канал соединения с устройством будет использоваться - ***Локальная сеть*** или ***MQTT*** можно увидеть в специальном информационном поле на странице **"Подключение"**
в приложении:  

![Приложение-8](https://github.com/vvip-68/GyverPanelWiFi/blob/master/wiki/Tune/p11.png)

В случае подключение к устройству в ***локальной сети*** - указана IP адрес и порт подключения устройства.  
В случае подключение к устройству по к ***каналу MQTT*** - указано имя сервера (MQTT-брокер) и портподключения к серверу.  

# Настройка устройства из приложения

Итак, соединение с устройством установлено, интерфейс управления возможностями устройства - доступен. 
Можно приступать к настройке функций и эффектов.

## Общие настройки



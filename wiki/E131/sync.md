# Синхронизация устройств

- [Общие понятия](https://github.com/vvip-68/GyverPanelWiFi/wiki/Синхронизация-устройств#Общие-понятия)
- [Внешние эффекты Jinx!](https://github.com/vvip-68/GyverPanelWiFi/wiki/Синхронизация-устройств#Внешние-эффекты-jinx)
- [Настройка синхронизации](https://github.com/vvip-68/GyverPanelWiFi/wiki/Синхронизация-устройств#Настройка-синхронизации)
- [Технические аспекты](https://github.com/vvip-68/GyverPanelWiFi/wiki/Синхронизация-устройств#Технические-аспекты)
- [Возможные проблемы](https://github.com/vvip-68/GyverPanelWiFi/wiki/Синхронизация-устройств#Возможные-проблемы)

## Общие понятия

Прошивка поддерживает синхронизацию эффектов между устройствами. Может быть создано до 10 групп устройств.
Количество устройств в группе - не ограничено. Все синхронизированные устройства должны находиться в одной локальной сети.
Маршрутизатор должен обеспечивать корректную передачу многоадресных UDP пакетов в локальной сети - режим ***multicast***.
Настройку передачи multicast-пакетов в вашем роутере смотрите в документации на роутер.

![Сеть](https://github.com/vvip-68/GyverPanelWiFi/blob/master/wiki/E131/Network.jpg)

Устройства, объединенные в группу должны содержать одно **главное устройство** - источник (***MASTER***), остальные устройства группы являются **ведомыми** и должны быть настроены для работы в режиме приемник (***SLAVE***).

Прошивка поддерживает до 10 групп устройств - "Группа 0" .. "Группа 9", устройства в каждой группе работают синхронно, группы независимы.

### Режимы работы устройств

Каждое устройство может быть настроено в приложении-компаньоне **"WiFi Panel Setup"** для работы в одном из трех режимов:
- **Автономный режим** - устройство отключено от синхронизации, работает самостоятельно.
- **Источник** (мастер) - задает синхронизацию ведомым устройствам. Ведомые устройства воспроизводят те же эффекты, которые в настоящий момент отображаются на устройстве - источнике. Группа должна содержать не более одного устройства-источника.
- **Приемник** (ведомый) - принимает данные от главного устройства группы, повторяет эффекты, которые в настоящий момент отображает источник - мастер. Количество устройств-приемников в группе не ограничено. 

### Уровни синхронизации

Для корректной работы устройств в группе источник и приемник должны быть настроены на *одинаковые уровни* синхронизации.  
Существуют три уровня синхронизации устройств:
 - **Физическая** синхронизация
 - **Логическая** синхронизация
 - Синхронизация на уровне **команд**

#### Физический уровень

Физический уровень синхронизации является самым быстрым, поскольку полученные от источника пакеты данных не требуют дополнительной обработки и передаются "как есть" на матрицу устройства приемника. Этот режим синхронизации рекомендуется для устройств с большими матрицами, так как требуют минимальное время на обработку принятых данных.

Работа на физическом уровне синхронизации накладывает следующие ограничения на устройства группы:
- Размеры матриц всех устройств группы должны иметь одинаковый размер - высоту и ширину.
- Угол подключения матрицы и направление следования цепочки диодов из угла подключения должны быть одинаковым для всех устройств группы

Несоблюдение этих требований нарушит отображение эффектов - картинка будет искажена/рассинхронизирована. Максимальное количество диодов в матрице для этого режима - 1190. Для увеличения количества диодов (для слишком больших матриц) требуется корректировка кода в скетче. 

Физический уровень синхронизации устройств обеспечивает **абсолютную** синхронизацию устройств. Эффекты на всех устройствах группы будут выглядеть абсолютно синхронно, поскольку устройство-мастер передает устройствам-приемникам "картинку" со своей матрицы.

#### Логический уровень

Логический уровень синхронизации определяет отображение картинки эффекта с позиции (X,Y) = (0,0) - левый верхний угол картинки, направление следования "пикселей" картинки - слева направо по X, затем сверху вниз по Y. Логический уровень синхронизации требует дополнительных затрат на обработку пакетов принятых от мастера, зато нивелирует требование одинаковости угла подключения  и направления из угла матрицы для устройств в группе. Размеры матрицы (высота и ширина) по прежнему должны быть такими же как на устройстве - источнике.

Несоблюдение требования одинакового размера матриц нарушит отображение эффектов - картинка будет искажена/рассинхронизирована. Максимальное количество диодов в матрице для этого режима - 1190. Для увеличения количества диодов (для слишком больших матриц) требуется корректировка кода в скетче. 

Логический уровень синхронизации устройств обеспечивает **абсолютную** синхронизацию устройств. Эффекты на всех устройствах группы будут выглядеть абсолютно синхронно, поскольку устройство-мастер передает устройствам-приемникам "картинку" со своей матрицы.

#### Командный уровень

Командный уровень синхронизации хорошо работает для устройств группы, если размеры их матриц, угол подключения и направление цепочки светодиодов из угла не совпадают. Этот режим не позволяет добиться абсолютной синхронизации устройств, поскольку от ведущего устройства к приемникам передается не "картинка" эффекта, а команды - "включить эффект N", "установить яркость в значение X", "отобразить бегущую строку с текстом xxx" и подобные.

Часть эффектов имеют свои "подрежимы" - например эффект "радуга" имеет разновидности "Вертикальная", "Горизонтальная", "Диагональная", "Вращающаяся", "Случайный выбор". Эффекты "Анимация" или "SD-карта" - набор различных анимаций и роликов в качестве "подрежимов". Устройство приемник, получив от главного устройства команду "Включить эффект N" включит сам эффект, но "подрежимы" включенного эффекта совпадать не будут. Особенности технической реализации командного режима не позволяют синхронизировать варианты эффектов на всех устройствах группы.

![Сравнение](https://github.com/vvip-68/GyverPanelWiFi/blob/master/wiki/E131/Texts.png)


## Внешние эффекты Jinx!

Одним из вариантов синхронизации устройств в группе является ***внешняя синхронизация***. В этом режиме в группе нет устройства-источника, все устройства настроены на работу в режиме **"приемник"** (SLAVE). В качестве источника эффектов для отображения на всех устройствах группы используется одна из программ управления световым оборудованием и создания эффектов, поддерживающих протокол SACN E1.31 (DMX-512 over Ethernet) - [***"Jinx!***](http://www.live-leds.de/), ***"Glediator"***,  [***"Wixen lights"***](http://www.vixenlights.com), [***"XLights"***](http://xlights.org/) и подобные.

![Сеть](https://github.com/vvip-68/GyverPanelWiFi/blob/master/wiki/E131/Network-Jinx!.jpg)

Настройка внешнего источника синхронизации на примере программы управления световым оборудованием ***"Jinx!"*** описана в этой [статье](https://github.com/vvip-68/GyverPanelWiFi/wiki/Настройка-ПО-управления-эффектами-%22Jinx!%22-как-источника-синхронизации-устройств-в-группе).

## Настройка синхронизации

Задание роли для конкретного устройства производится в приложении-компаньоне ***"WiFi Panel Setup"***. Скачайте и установите приложение из архива проекта из папки ***Android***. Создайте учетную запись устройства, задайте имя и укажите его IP. Порт оставьте по умолчанию. Нажмите кнопку "Подключить".

![Настройка](https://github.com/vvip-68/GyverPanelWiFi/blob/master/wiki/E131/setup1.png)
![Настройка](https://github.com/vvip-68/GyverPanelWiFi/blob/master/wiki/E131/setup2.png) 

Перейдите к разделу "Настройки синхронизации".

![Настройка](https://github.com/vvip-68/GyverPanelWiFi/blob/master/wiki/E131/setup3.png) 

Выберите нужный *режим работы* устройства - ***Автономный***, ***"Источник"*** или ***"Приемник"***.  
При выборе режима *"Источник"* или *"Приемник"* станут доступными опции настройки *режима синхронизации*. Выберите нужный.  
Установите в комбобоксе *группу синхронизации*. Этот параметр должен совпадать для всех устройств группы.
Сохраните настройки - нажмите кнопку ***"Сохранить"***. Устройство перейдет в работу в соответствующем настройкам режиме.

Выполните описанные действия для всех устройств группы.
Если мастер-устройство доступно в сети...   
- В режиме синхронизации ***физический*** и ***логический*** картинка с матрицы ведущего устройства (источника) станет незамедлительно отображаться на устройствах, работающих в режиме приемника. После отключения мастера, когда данные потока синхронизации перестанут поступать к приемникам, они перейдут в автономный режим после двухсекундной паузы (в это время они ожидают продолжения поступления данных от мастера).
- В режиме синхронизации ***команды*** устройства приемники получат команду и выполнят синхронизацию в момент смены эффекта на мастер-устройстве.
В случае отключения мастер-устройства (переключение его в автономный режим или выключении питания) устройства приемники продолжат воспроизведение последнего полученного эффекта. Если в настройках приемника задан таймаут перехода из установленного режима к автоматическому перебору эффектов, демо-режим включится автоматически по истечении указанного таймаута.

## Технические аспекты

## Возможные проблемы

- На устаревших роутерах типа DIR-615 замечены неполадки на устройствах-приемниках, работающих в режиме ***SLAVE***  
  - **Проявление**: изображение эффекта с MASTER на устройствах SLAVE отображается не полностью, не на всей матрице, а только на первых 170 диодах. На остальной части матрицы диоды не светятся.  
  - **Причина**: роутер отдает устройствам только первый многоадресный пакет из кадра, остальные пакеты роутером устройству-приемнику не передаются.  
  - **Решение**: обычно решить проблему помогает перезагрузка роутера. Если проблема возникает достаточно часто - рекомендуется замена роутера на более современный.

- Современные роутеры типа TPLink серии Archer имеют ошибку в прошивке.
  - **Проявление**: после выключения питания ведомых устройств роутер перестает отвечать. Пинг на роутер не проходит, Web-страница настройки роутера не открывается. Компьютеры в сети сообщают, что интернет не доступен.
  - **Причина**: ошибка в прошивке роутера.
  - **Решение**: адекватного решения в настоящий момент не существует. Ожидается обновление прошивки роутера. Восстановить доступ в интернет и доступность роутера помогает его перезагрузка. Впрочем, если роутер не трогать, он восстановится самостоятельно через 5-7 минут. Включение питания  устройств-приемников обратно также восстанавливает работоспособность роутера и доступность интернета в течение 20-30 секунд.

